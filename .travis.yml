dist: trusty

sudo: required

language: node_js

cache: yarn

notifications:
  email: false

node_js:
  - '7'

php:
  - '7.0'

services:
  - mysql

branches:
  except:
    - "/^v\\d+\\.\\d+\\.\\d+$/"

before_install:
  - export CHROME_BIN=chromium-browser
#  - sudo apt-get install php7.0 php7.0-fpm php7.0-mysql php7.0-curl php7.0-json php7.0-cgi -y

before_script:
  # install Apache
  - sudo apt-get update
  - sudo apt-get install apache2
  - sudo a2enmod rewrite alias
  # install toolwatch backend
  - git clone --depth=50 --branch=master https://github.com/Toolwatchapp/tw-backend.git tw-backend
  - "curl -u ${DATABASE_USER}:${DATABASE_PW} \"${DATABASE_URL}\" > database.sql && mysql -u root -e 'source database.sql'"
  # configure apache virtual hosts
  - cat tests/e2e/travis-ci-apache
  - rm /etc/apache2/sites-enable/*
  - sudo cp -f tests/e2e/travis-ci-apache /etc/apache2/sites-enable/default
  - sudo sed -e "s?%TRAVIS_BUILD_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-enable/default
  - cat /etc/apache2/sites-available/default
  - ls tw-backend/
  - ls /etc/apache2/sites-enable/default
  - pwd
  - sudo service apache2 restart
  # node configuration
  - npm prune
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start

script: 
  - npm run test
  - sh coverage-checker.sh
  - php -r 'echo "Php works\n";'
  - curl http://localhost

after_success:
   - npm run coverage
   
# notifications:
#   slack: toolwatchapp:AfvHCPE9Em1MY3j04gdlqbYe
#   email: false
